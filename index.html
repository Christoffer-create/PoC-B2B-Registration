<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Account Creation</title>
    <style>
        #loadingContainer {
            display: none; /* Ensure the spinner is hidden initially */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 10px solid #f3f3f3; /* 60% of the original 16px */
            border-top: 10px solid #3498db; /* 60% of the original 16px */
            border-radius: 50%;
            width: 72px; /* 60% of the original 120px */
            height: 72px; /* 60% of the original 120px */
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
            text-align: center;
            margin: 0;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: auto;
        }

        .section-title {
            background-color: #143275;
            color: white;
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            border-radius: 5px 5px 0 0;
            width: 100%;
            box-sizing: border-box;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        td {
            padding: 10px;
            text-align: left;
        }

        input {
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .button {
            background-color: #143275;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .button:hover {
            background-color: #0f255a;
        }

        .full-width-button {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="loadingContainer">
        <div class="spinner"></div>
        <p>Searching for account, please wait...</p>
    </div>
    <div class="container">
        <h1>B2B Account Creation</h1>

        <!-- Sponsor Details Section -->
        <div class="section-title">Sponsor Details</div>
        <div class="table-container">
            <table>
                <tr>
                    <td><strong>Sponsor Email:</strong></td>
                </tr>
                <tr>
                    <td><input type="text" id="sponsorEmail" readonly></td>
                </tr>
                <tr>
                    <td><strong>Sponsor User ID:</strong></td>
                </tr>
                <tr>
                    <td><input type="text" id="sponsorUserId" readonly></td>
                </tr>
            </table>
        </div>

        <!-- B2B Account Information Section -->
        <div class="section-title">B2B Account Information</div>
        <div class="table-container">
            <table>
                <tr>
                    <td><strong>External User Email:</strong></td>
                </tr>
                <tr>
                    <td class="button-container">
                   <input type="text" id="externalUserEmail">
                   <button class="button" onclick="verifyUser()">Verify</button>
                    </td>
                </tr>
                <td><strong>First name:</strong></td>
                </tr>
                <tr>
                <td><input type="text" id="givenName"></td>
                </tr>
                <tr>
                    <td><strong>Last Name:</strong></td>
                </tr>
                <tr>
                    <td><input type="text" id="lastName"></td>
                </tr>
                <tr>
                    <td><strong>Company:</strong></td>
                </tr>
                <tr>
                    <td><input type="text" id="company"></td>
                </tr>
                <tr>
                    <td><strong>Phone Number:</strong></td>
                </tr>
                <tr>
                    <td><input type="text" id="phoneNumber"></td>
                </tr>
<tr>
  <td><strong>Country:</strong></td>
</tr>
<tr>
  <td>
    <select id="usageLocation">
      <option value="SE">Sweden</option>
      <option value="PL">Poland</option>
      <option value="NO">Norway</option>
      <option value="US">United States</option>
      <option value="UK">United Kingdom</option>
      <option value="HU">Hungary</option>
      <option value="CZ">Czech Republic</option>
      <option value="SK">Slovakia</option>
    </select>
  </td>
</tr>
            </table>
        </div>

        <button class="button full-width-button" id="submitButton">Submit</button>
    </div>

    <script>
        // Fetch session user info
        document.addEventListener("DOMContentLoaded", async () => {
            async function getUserInfo() {
                try {
                    const response = await fetch('/.auth/me');
                    if (!response.ok) throw new Error("Not authenticated");
                    const payload = await response.json();
                    return payload.clientPrincipal;
                } catch (error) {
                    console.error("Error fetching user info:", error);
                    return null;
                }
            }

            const user = await getUserInfo();
            if (user) {
                document.getElementById("sponsorEmail").value = user.userDetails;
                document.getElementById("sponsorUserId").value = user.userId;
            } else {
                document.getElementById("sponsorEmail").value = "Not logged in";
                document.getElementById("sponsorUserId").value = "Not logged in";
            }
        });

        function clearFields() {
    document.getElementById("givenName").value = "";
    document.getElementById("lastName").value = "";
    document.getElementById("company").value = "";
    document.getElementById("phoneNumber").value = "";
    document.getElementById("givenName").value = "";
    document.getElementById("usageLocation").value = "";
}

        // Verify Button Click - Checks Entra ID for Existing User
async function verifyUser() {
    const email = document.getElementById("externalUserEmail").value;
    if (!email) {
        alert("Please enter an email to verify.");
        return;
    }
           document.getElementById("loadingContainer").style.display = "flex";
    try {
        const response = await fetch("https://prod-243.westeurope.logic.azure.com:443/workflows/59389dfa65a94805812431c37632b78f/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=4Z3LMxjwyiznVxUaofinBdcLSN9JBQYp6eE6QUFkLrk", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ email: email })
        });

        if (response.status === 404) {
            clearFields();
            alert("No account found.");
            return;
        }

        if (!response.ok) throw new Error("User not found");

        const data = await response.json();

        if (data.lastName || data.company || data.phoneNumber || data.givenName || data.usageLocation) {
            document.getElementById("lastName").value = data.lastName || "";
            document.getElementById("company").value = data.company || "";
            document.getElementById("phoneNumber").value = data.phoneNumber || "";
            document.getElementById("givenName").value = data.givenName || "";
            document.getElementById("usageLocation").value = data.usageLocation || "";
            alert("An account with the given email exists!");
        } else {
            alert("No account found.");
        }

    } catch (error) {
        clearFields();
        alert("Error: " + error.message);
    } finally {
    document.getElementById("loadingContainer").style.display = "none";
}
}


        // Submit Button Click - Send Data to Logic App
        document.getElementById("submitButton").addEventListener("click", async () => {
            const payload = {
                givenName: document.getElementById("givenName").value,
                sponsorEmail: document.getElementById("sponsorEmail").value,
                sponsorUserId: document.getElementById("sponsorUserId").value,
                externalUserEmail: document.getElementById("externalUserEmail").value,
                lastName: document.getElementById("lastName").value,
                company: document.getElementById("company").value,
                phoneNumber: document.getElementById("phoneNumber").value,
                usageLocation: document.getElementById("usageLocation").value
            };

            try {
                const response = await fetch("https://prod-11.westeurope.logic.azure.com:443/workflows/b23e1da5f44a44d4911c31e5e7197a20/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=i0sgLEvvxCUkGDw7Z07QeOaypQ8M4VORZeH8cXZUM1s", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert("Form submitted successfully!");
                if (response.status === 203) {
                alert(`✅ Account Created Successfully!  
               \n👤 Name: ${data.givenName} ${data.lastName}  
               \n📧 Email: ${data.externalUserEmail}  
               \n🏢 Company: ${data.company}  
               \n📞 Phone: ${data.phoneNumber}  
               \n🌍 Country: ${data.usageLocation}`);
                } else {
                    alert("Failed to submit form.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error submitting form.");
                alert("❌ Error creating account. Please try again.");
            }
        });
    </script>
</body>
</html>
