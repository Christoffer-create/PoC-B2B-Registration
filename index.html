<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>External User Registration</title>
    <style>
        .message {
            display: none;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .full-width-button { width: 100%; }
        .table-container { display: flex; justify-content: center; }
        table { width: 50%; border-collapse: collapse; }
        td { padding: 10px; }
    </style>
</head>
<body>
    <h2>External User Registration</h2>
    
    <div class="table-container">
        <table border="1">
            <tr>
                <td>Sponsor Email:</td>
                <td>
                    <input type="email" id="sponsorEmail">
                    <button id="verifySponsorButton" onclick="verifySponsor()">Verify</button>
                    <span id="verifySpinner" style="display: none;">ðŸ”„</span>
                    <input type="hidden" id="sponsorUserId"> <!-- HIDDEN FIELD -->
                    <div id="sponsorMessage" class="message"></div>
                </td>
            </tr>
            <tr>
                <td>External User Email:</td>
                <td>
                    <input type="email" id="externalUserEmail">
                    <button onclick="verifyExternalUser()">Check</button>
                    <span id="externalUserVerifySpinner" style="display: none;">ðŸ”„</span>
                    <div id="userFoundMessage" class="message"></div>
                </td>
            </tr>
            <tr>
                <td>Given Name:</td>
                <td><input type="text" id="givenName"></td>
            </tr>
            <tr>
                <td>Last Name:</td>
                <td><input type="text" id="lastName"></td>
            </tr>
            <tr>
                <td>Company:</td>
                <td><input type="text" id="company"></td>
            </tr>
            <tr>
                <td>Phone Number:</td>
                <td><input type="text" id="phoneNumber"></td>
            </tr>
            <tr>
                <td>Usage Location:</td>
                <td><input type="text" id="usageLocation"></td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center;">
                    <button class="button full-width-button" id="submitButton" onclick="submitForm()" disabled>Submit</button>
                </td>
            </tr>
        </table>
    </div>

    <script>
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = "message " + (type === "success" ? "success" : "error");
            element.style.display = "block";
        }

        function resetMessages() {
            document.querySelectorAll(".message").forEach(msg => {
                msg.textContent = "";
                msg.style.display = "none";
            });
        }

        function disableSubmitButton() {
            document.getElementById("submitButton").disabled = true;
            document.getElementById("submitButton").style.backgroundColor = "#ccc";
        }

        function enableSubmitButton() {
            document.getElementById("submitButton").disabled = false;
            document.getElementById("submitButton").style.backgroundColor = "#143275";
        }

        async function verifySponsor() {
            resetMessages();  // Clear old messages

            const sponsorEmail = document.getElementById("sponsorEmail").value;
            const verifyButton = document.getElementById("verifySponsorButton");
            const spinner = document.getElementById("verifySpinner");

            if (!sponsorEmail) {
                showMessage("sponsorMessage", "Please enter a sponsor email.", "error");
                return;
            }

            verifyButton.disabled = true;
            spinner.style.display = "inline-block";

            try {
                const response = await fetch('https://prod-144.westeurope.logic.azure.com:443/workflows/7a097d990a4847d19bf87b534098979d/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=eMEoDsIKXzBRk4vIBsvjPay6D5TqTGdA3rbgQp43Soc', { 
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: sponsorEmail })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("sponsorUserId").value = data.sponsorUserId || "";
                    showMessage("sponsorMessage", "Sponsor verified successfully!", "success");
                    enableSubmitButton();
                } else {
                    showMessage("sponsorMessage", "Sponsor not found.", "error");
                    document.getElementById("sponsorUserId").value = "";
                    disableSubmitButton();
                }
            } catch (error) {
                showMessage("sponsorMessage", "Error verifying sponsor.", "error");
                disableSubmitButton();
            } finally {
                verifyButton.disabled = false;
                spinner.style.display = "none";
            }
        }

        async function verifyExternalUser() {
            resetMessages();

            const externalUserEmail = document.getElementById("externalUserEmail").value;
            const spinner = document.getElementById("externalUserVerifySpinner");

            if (!externalUserEmail) {
                showMessage("userFoundMessage", "Please enter an external user email.", "error");
                return;
            }

            spinner.style.display = "inline-block";

            try {
                const response = await fetch('https://prod-243.westeurope.logic.azure.com:443/workflows/59389dfa65a94805812431c37632b78f/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=4Z3LMxjwyiznVxUaofinBdcLSN9JBQYp6eE6QUFkLrk', { 
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email: externalUserEmail })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("givenName").value = data.givenName || "";
                    document.getElementById("lastName").value = data.lastName || "";
                    document.getElementById("company").value = data.company || "";
                    document.getElementById("phoneNumber").value = data.phoneNumber || "";
                    document.getElementById("usageLocation").value = data.usageLocation || "";

                    showMessage("userFoundMessage", "User found and details populated.", "success");
                    disableSubmitButton(); // Prevent submission if user exists
                } else {
                    showMessage("userFoundMessage", "User not found, ready to register.", "success");
                    enableSubmitButton();
                }
            } catch (error) {
                showMessage("userFoundMessage", "Error verifying user.", "error");
                disableSubmitButton();
            } finally {
                spinner.style.display = "none";
            }
        }

async function submitForm() {
    resetMessages(); // Clear previous messages

    const submitButton = document.getElementById("submitButton");
    submitButton.disabled = true;
    submitButton.textContent = "Submitting...";

    // Collect form data
    const formData = {
        sponsorUserId: document.getElementById("sponsorUserId").value,
        sponsorEmail: document.getElementById("sponsorEmail").value,
        externalUserEmail: document.getElementById("externalUserEmail").value,
        givenName: document.getElementById("givenName").value,
        lastName: document.getElementById("lastName").value,
        company: document.getElementById("company").value,
        phoneNumber: document.getElementById("phoneNumber").value,
        usageLocation: document.getElementById("usageLocation").value
    };

    try {
        const response = await fetch('https://prod-11.westeurope.logic.azure.com:443/workflows/b23e1da5f44a44d4911c31e5e7197a20/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=i0sgLEvvxCUkGDw7Z07QeOaypQ8M4VORZeH8cXZUM1s', {  // Replace '' with your API endpoint
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            showMessage("userFoundMessage", "User registered successfully!", "success");
        } else {
            showMessage("userFoundMessage", "Failed to register user.", "error");
        }
    } catch (error) {
        showMessage("userFoundMessage", "Network error. Please try again.", "error");
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = "Submit";
    }
}

    </script>
</body>
</html>
